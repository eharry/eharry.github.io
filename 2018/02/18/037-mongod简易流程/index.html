<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>037-mongod简易流程 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="任何一个现代数据库,从组件上来分, 都是客户端和服务端, 如果再具体细分服务端, 一般存储引擎都采用插件的方式, 所以服务端又可以细分为 框架和存储引擎实现. 一般来说,框架干的事情都是跟客户端的网络交互等一些共用的特性. 所以一般的数据库二次开发,也都是在框架的基础上做的开发, 比如增强某些限制功能, 给某些用户特权,增加审计功能等.">
<meta name="keywords" content="mongodb,">
<meta property="og:type" content="article">
<meta property="og:title" content="037-mongod简易流程">
<meta property="og:url" content="https://eharry.github.io/2018/02/18/037-mongod简易流程/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="任何一个现代数据库,从组件上来分, 都是客户端和服务端, 如果再具体细分服务端, 一般存储引擎都采用插件的方式, 所以服务端又可以细分为 框架和存储引擎实现. 一般来说,框架干的事情都是跟客户端的网络交互等一些共用的特性. 所以一般的数据库二次开发,也都是在框架的基础上做的开发, 比如增强某些限制功能, 给某些用户特权,增加审计功能等.">
<meta property="og:updated_time" content="2018-02-21T14:27:06.868Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="037-mongod简易流程">
<meta name="twitter:description" content="任何一个现代数据库,从组件上来分, 都是客户端和服务端, 如果再具体细分服务端, 一般存储引擎都采用插件的方式, 所以服务端又可以细分为 框架和存储引擎实现. 一般来说,框架干的事情都是跟客户端的网络交互等一些共用的特性. 所以一般的数据库二次开发,也都是在框架的基础上做的开发, 比如增强某些限制功能, 给某些用户特权,增加审计功能等.">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://eharry.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-037-mongod简易流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/18/037-mongod简易流程/" class="article-date">
  <time datetime="2018-02-18T01:33:08.000Z" itemprop="datePublished">2018-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      037-mongod简易流程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>任何一个现代数据库,从组件上来分, 都是客户端和服务端, 如果再具体细分服务端, 一般存储引擎都采用插件的方式, 所以服务端又可以细分为 框架和存储引擎实现.</p>
<p>一般来说,框架干的事情都是跟客户端的网络交互等一些共用的特性. 所以一般的数据库二次开发,也都是在框架的基础上做的开发, 比如增强某些限制功能, 给某些用户特权,增加审计功能等.</p>
<a id="more"></a>
<p>MessageHandler 可以说是整个mongodb最核心的消息处理类, 当然当前这个类仅仅定义了一个借口文件,具体实现,需要参考MessageHandler的子类.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class MessageHandler &#123;</span><br><span class="line">public:</span><br><span class="line">    virtual ~<span class="function"><span class="title">MessageHandler</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called once when a socket is connected.</span><br><span class="line">     */</span><br><span class="line">    virtual void connected(AbstractMessagingPort* p) = 0;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called every time a message comes <span class="keyword">in</span>. Handler is responsible <span class="keyword">for</span> responding to client.</span><br><span class="line">     */</span><br><span class="line">    virtual void process(Message&amp; m, AbstractMessagingPort* p) = 0;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called once, either when the client disconnects or when the process is shutting down. After</span><br><span class="line">     * close() is called, this handler<span class="string">'s AbstractMessagingPort pointer (passed in via the</span></span><br><span class="line"><span class="string">     * connected() method) is no longer valid.</span></span><br><span class="line"><span class="string">     */</span></span><br><span class="line"><span class="string">    virtual void close() = 0;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>
<p>在整个mongodb代码中, MessageHandler共有三个子类,分别是</p>
<ol>
<li>MyMessageHandler  位于 db.cpp</li>
<li>DummyMessageHandler 位于 Scoped_db_conn_test.cpp</li>
<li>ShardedMessageHandler 位于Server.cpp</li>
</ol>
<p>忽略测代码,上面的1,对应的是smongod的messagehandler, 而3,对应的则是mongos的messagehandler.</p>
<p>先看一下 mongod的messagehandler, 也就是MyMessageHandler  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class MyMessageHandler : public MessageHandler &#123;</span><br><span class="line">public:</span><br><span class="line">    virtual void connected(AbstractMessagingPort* p) &#123;</span><br><span class="line">        Client::initThread(<span class="string">"conn"</span>, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void process(Message&amp; m, AbstractMessagingPort* port) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            DbResponse dbresponse;</span><br><span class="line">            &#123;</span><br><span class="line">                auto opCtx = getGlobalServiceContext()-&gt;makeOperationContext(&amp;cc());</span><br><span class="line">                assembleResponse(opCtx.get(), m, dbresponse, port-&gt;remote());</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            port-&gt;reply(m, dbresponse.response, dbresponse.responseTo);</span><br><span class="line">            <span class="built_in">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void <span class="function"><span class="title">close</span></span>() &#123;</span><br><span class="line">        Client::destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>缩减了一些不必要的代码后,可以看出, connected和close函数, 是辅助类函数, 主要的服务响应, 都在process函数里. process, 通过assembleResponse函数,得到命令的返回结果, 并通过port-&gt;reply函数进行通讯响应.</p>
<p>MessageServer 定义了mongodb服务器的行为,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class MessageServer &#123;</span><br><span class="line">public:</span><br><span class="line">    struct Options &#123;</span><br><span class="line">        int port;            // port to <span class="built_in">bind</span> to</span><br><span class="line">        std::string ipList;  // addresses to <span class="built_in">bind</span> to</span><br><span class="line"></span><br><span class="line">        Options() : port(0), ipList(<span class="string">""</span>) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    virtual ~<span class="function"><span class="title">MessageServer</span></span>() &#123;&#125;</span><br><span class="line">    virtual void run() = 0;</span><br><span class="line">    virtual void setAsTimeTracker() = 0;</span><br><span class="line">    virtual bool setupSockets() = 0;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在整个mongodb的代码中,MessageServer只要一个子类,也就是PortMessageServer.</p>
<p>从函数createServer也可以看出,只要是创建server,基本上就是PortMessageServer.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MessageServer* createServer(const MessageServer::Options&amp; opts,</span><br><span class="line">                            std::shared_ptr&lt;MessageHandler&gt; handler) &#123;</span><br><span class="line">    <span class="built_in">return</span> new PortMessageServer(opts, std::move(handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而PortMessageServer的定义如下,我删去了我认为不重要的部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PortMessageServer</span> :</span> <span class="keyword">public</span> MessageServer, <span class="keyword">public</span> Listener &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    PortMessageServer(<span class="keyword">const</span> MessageServer::Options&amp; opts, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;MessageHandler&gt; handler)</span><br><span class="line">        : Listener(<span class="string">""</span>, opts.ipList, opts.port), _handler(<span class="built_in">std</span>::move(handler)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accepted</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Socket&gt; psocket, <span class="keyword">long</span> <span class="keyword">long</span> connectionId)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initAndListen();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;MessageHandler&gt; _handler;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">handleIncomingMsg</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先,这个类PortMessageServer, 不仅仅是MessageServer的子类,也是Listener子类,所以表示它也实现了Listener的一些工作. </p>
<p>先看构造函数,传入参数很简单, 只有两个</p>
<ol>
<li>MessageServer::Options&amp; opts</li>
<li>std::shared_ptr<messagehandler></messagehandler></li>
</ol>
<p>opts,就是两个构成,一个是ipList,表示服务监听的ip列表, 一个是端口.</p>
<p>handleIncomingMsg是静态函数,那么可知, 这个_handlerc成员变量,并不能在这个函数中访问.</p>
<p>肯定是通过arg将所需要的参数一并传入其中.</p>
<p>server.run方法里面,仅仅运行了 initAndListen, 可以猜到这个函数应该具有一个无线循环的loop.</p>
<p>那么下来一块看一下这个 initAndListen 函数, 底下函数是我删去了我认为不重要的部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Listener::initAndListen() &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (!inShutdown()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        maxSelectTime.tv_sec = <span class="number">0</span>;</span><br><span class="line">        maxSelectTime.tv_usec = <span class="number">10000</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> ret = select(maxfd + <span class="number">1</span>, fds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;maxSelectTime);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">vector</span>&lt;SOCKET&gt;::iterator it = _socks.begin(), end = _socks.end(); it != end; ++it) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(FD_ISSET(*it, fds)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            SockAddr from;</span><br><span class="line">            <span class="keyword">int</span> s = accept(*it, from.raw(), &amp;from.addressSize);</span><br><span class="line">            ...</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Socket&gt; pnewSock(<span class="keyword">new</span> Socket(s, from));</span><br><span class="line">            ...</span><br><span class="line">            accepted(pnewSock, myConnectionNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看简化后的initAndListen, 可见整个函数在while循环中, 只要不是shutdown, 就一直会跑这个循环.</p>
<p>程序会阻塞在select这个函数中, 当有新的连接接入时, 系统会执行 accepted函数. </p>
<p>从gdb的路径也可以看出,系统确实是停留在了mongo::Listener::initAndListen的select函数上.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#0  0x00007f9c5c132593 in select () at ../sysdeps/unix/syscall-template.S:84</span></span><br><span class="line"><span class="comment">#1  0x0000000002b8b04e in mongo::Listener::initAndListen (this=0x58d4368) at src/mongo/util/net/listen.cpp:269</span></span><br><span class="line"><span class="comment">#2  0x0000000002b94804 in mongo::PortMessageServer::run (this=0x58d4360) at src/mongo/util/net/message_server_port.cpp:174</span></span><br><span class="line"><span class="comment">#3  0x0000000001f5db8e in mongo::(anonymous namespace)::_initAndListen (listenPort=27017) at src/mongo/db/db.cpp:791</span></span><br><span class="line"><span class="comment">#4  0x0000000001f5e0c2 in mongo::(anonymous namespace)::initAndListen (listenPort=27017) at src/mongo/db/db.cpp:796</span></span><br><span class="line"><span class="comment">#5  0x0000000001f5f588 in mongoDbMain (argc=1, argv=0x7ffe2c890408, envp=0x7ffe2c890418) at src/mongo/db/db.cpp:1032</span></span><br><span class="line"><span class="comment">#6  0x0000000001f5e3fc in main (argc=1, argv=0x7ffe2c890408, envp=0x7ffe2c890418) at src/mongo/db/db.cpp:843</span></span><br></pre></td></tr></table></figure>
<p>注意,这个accepted就是PortMessageServer里面定义一个accepted函数.</p>
<p>accpeted函数如下, 任然是删去了不重要的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accepted</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Socket&gt; psocket, <span class="keyword">long</span> <span class="keyword">long</span> connectionId)</span> </span>&#123;</span><br><span class="line">        ScopeGuard sleepAfterClosingPort = MakeGuard(sleepmillis, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;MessagingPortWithHandler&gt; portWithHandler(</span><br><span class="line">            <span class="keyword">new</span> MessagingPortWithHandler(psocket, _handler, connectionId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">pthread_attr_t</span> attrs;</span><br><span class="line">            pthread_attr_init(&amp;attrs);</span><br><span class="line">            pthread_attr_setdetachstate(&amp;attrs, PTHREAD_CREATE_DETACHED);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">size_t</span> STACK_SIZE = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">            <span class="keyword">size_t</span> stackSizeToSet = STACK_SIZE;</span><br><span class="line">            pthread_attr_setstacksize(&amp;attrs, stackSizeToSet);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">pthread_t</span> thread;</span><br><span class="line">            <span class="keyword">int</span> failed = pthread_create(&amp;thread, &amp;attrs, &amp;handleIncomingMsg, portWithHandler.get());</span><br><span class="line"></span><br><span class="line">            pthread_attr_destroy(&amp;attrs);</span><br><span class="line"></span><br><span class="line">            portWithHandler.release();</span><br><span class="line">            sleepAfterClosingPort.Dismiss();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个accpeted函数很简单, </p>
<ol>
<li>把传入的psocket, connectionId和类成员变量_handler封装到对象 portWithHandler中</li>
<li>创建一个thread, 运行handleIncomingMsg, 传入参数是portWithHandler.</li>
</ol>
<p>这也就就是了为什么_handler可以在handleIncomingMsg被引用了.</p>
<p>这块,我们可以看到, 代码中对每个thread的堆栈大小,进行了设置 1M. 这也就是每个连接创建时,消耗1m内存的由来. </p>
<p>再看一下handleIncomingMsg的源代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">handleIncomingMsg</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">unique_ptr</span>&lt;MessagingPortWithHandler&gt; portWithHandler(</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;MessagingPortWithHandler*&gt;(arg));</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;MessageHandler&gt; handler = portWithHandler-&gt;getHandler();</span><br><span class="line"></span><br><span class="line">        setThreadName(<span class="built_in">std</span>::<span class="built_in">string</span>(str::stream() &lt;&lt; <span class="string">"conn"</span> &lt;&lt; portWithHandler-&gt;connectionId()));</span><br><span class="line"></span><br><span class="line">        Message m;</span><br><span class="line">        <span class="keyword">int64_t</span> counter = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            handler-&gt;connected(portWithHandler.get());</span><br><span class="line">            ON_BLOCK_EXIT([handler]() &#123; handler-&gt;close(); &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (!inShutdown()) &#123;</span><br><span class="line">                m.reset();</span><br><span class="line">                portWithHandler-&gt;psock-&gt;clearCounters();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!portWithHandler-&gt;recv(m)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                handler-&gt;process(m, portWithHandler.get());</span><br><span class="line">                networkCounter.hit(portWithHandler-&gt;psock-&gt;getBytesIn(),</span><br><span class="line">                                   portWithHandler-&gt;psock-&gt;getBytesOut());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Occasionally we want to see if we're using too much memory.</span></span><br><span class="line">                <span class="keyword">if</span> ((counter++ &amp; <span class="number">0xf</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    markThreadIdle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>...</span><br><span class="line">        portWithHandler-&gt;shutdown();</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>研究一个线程, 首先先看他什么时候开始, linux中,当线程被创建出来后,就有可能开始运行了,具体取决于os调度,但可以知道的是,并不需要在父线程再调用一次start命令.</p>
<p>而线程退出的调节,可以看出是portWithHandler-&gt;recv返回false的时候, 这个循环退出.</p>
<p>这里具体处理连接事务的,就是前面说的MyMessageHandler, 分别调用了</p>
<ol>
<li>handler-&gt;connected(portWithHandler.get());</li>
<li>handler-&gt;process(m, portWithHandler.get());</li>
<li>ON_BLOCK_EXIT(<a href="">handler</a> { handler-&gt;close(); });</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">assembleResponse</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                      Message&amp; m,</span></span></span><br><span class="line"><span class="function"><span class="params">                      DbResponse&amp; dbresponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> HostAndPort&amp; remote)</span> </span>&#123;</span><br><span class="line">    <span class="function">DbMessage <span class="title">dbmsg</span><span class="params">(m)</span></span>;</span><br><span class="line"></span><br><span class="line">    Client&amp; c = *txn-&gt;getClient();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ns = dbmsg.messageShouldHaveNs() ? dbmsg.getns() : <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> NamespaceString nsString = ns ? NamespaceString(ns) : NamespaceString();</span><br><span class="line"></span><br><span class="line">    CurOp&amp; currentOp = *CurOp::get(txn);</span><br><span class="line">    &#123;</span><br><span class="line">        stdx::lock_guard&lt;Client&gt; lk(*txn-&gt;getClient());</span><br><span class="line">        <span class="comment">// Commands handling code will reset this if the operation is a command</span></span><br><span class="line">        <span class="comment">// which is logically a basic CRUD operation like query, insert, etc.</span></span><br><span class="line">        currentOp.setNetworkOp_inlock(op);</span><br><span class="line">        currentOp.setLogicalOp_inlock(networkOpToLogicalOp(op));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op == dbQuery) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCommand) &#123;</span><br><span class="line">            receivedCommand(txn, nsString, c, dbresponse, m);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            receivedQuery(txn, nsString, c, dbresponse, m);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == dbCommand) &#123;</span><br><span class="line">        receivedRpc(txn, c, dbresponse, m);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == dbGetMore) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!receivedGetMore(txn, dbresponse, m, currentOp))</span><br><span class="line">            shouldLogOpDebug = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == dbMsg) &#123;</span><br><span class="line">        <span class="comment">// deprecated - replaced by commands</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* p = dbmsg.getns();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = <span class="built_in">strlen</span>(p);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"end"</span>, p) == <span class="number">0</span>)</span><br><span class="line">            dbresponse.response.setData(opReply, <span class="string">"dbMsg end no longer supported"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            dbresponse.response.setData(opReply, <span class="string">"i am fine - dbMsg deprecated"</span>);</span><br><span class="line"></span><br><span class="line">        dbresponse.responseTo = m.header().getId();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (op == dbKillCursors) &#123;</span><br><span class="line">                currentOp.ensureStarted();</span><br><span class="line">                logThreshold = <span class="number">10</span>;</span><br><span class="line">                receivedKillCursors(txn, m);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op != dbInsert &amp;&amp; op != dbUpdate &amp;&amp; op != dbDelete) &#123;</span><br><span class="line">                shouldLogOpDebug = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (op == dbInsert) &#123;</span><br><span class="line">                    receivedInsert(txn, nsString, m, currentOp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == dbUpdate) &#123;</span><br><span class="line">                    receivedUpdate(txn, nsString, m, currentOp);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == dbDelete) &#123;</span><br><span class="line">                    receivedDelete(txn, nsString, m, currentOp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">const</span> UserException&amp; ue) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出,这个函数就是一个分支函数,根据不同的op,进行不同的处理, </p>
<p>以receivedCommand为例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">receivedCommand</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> NamespaceString&amp; nss,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Client&amp; client,</span></span></span><br><span class="line"><span class="function"><span class="params">                            DbResponse&amp; dbResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Message&amp; message)</span> </span>&#123;</span><br><span class="line">    invariant(nss.isCommand());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> MSGID responseTo = message.header().getId();</span><br><span class="line"></span><br><span class="line">    <span class="function">DbMessage <span class="title">dbMessage</span><span class="params">(message)</span></span>;</span><br><span class="line">    <span class="function">QueryMessage <span class="title">queryMessage</span><span class="params">(dbMessage)</span></span>;</span><br><span class="line"></span><br><span class="line">    CurOp* op = CurOp::get(txn);</span><br><span class="line"></span><br><span class="line">    rpc::LegacyReplyBuilder builder&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    runCommands(txn, request, &amp;builder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> response = builder.done();</span><br><span class="line"></span><br><span class="line">    op-&gt;debug().responseLength = response.header().dataLen();</span><br><span class="line"></span><br><span class="line">    dbResponse.response = <span class="built_in">std</span>::move(response);</span><br><span class="line">    dbResponse.responseTo = responseTo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心都封装到runCommands里面, </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runCommands</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span></span></span><br><span class="line"><span class="function"><span class="params">                 rpc::ReplyBuilderInterface* replyBuilder)</span> </span>&#123;</span><br><span class="line">    Command::execCommand(txn, c, request, replyBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Command::execCommand, 经过一系列的检查后,运行了command-&gt;run函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Command::execCommand(OperationContext* txn,</span><br><span class="line">                          Command* command,</span><br><span class="line">                          <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span><br><span class="line">                          rpc::ReplyBuilderInterface* replyBuilder) &#123;</span><br><span class="line"></span><br><span class="line">        rpc::setOperationProtocol(txn, request.getProtocol());  <span class="comment">// SERVER-21485.  Remove after 3.2</span></span><br><span class="line"></span><br><span class="line">        dassert(replyBuilder-&gt;getState() == rpc::ReplyBuilderInterface::State::kCommandReply);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> dbname = request.getDatabase().toString();</span><br><span class="line">        <span class="built_in">unique_ptr</span>&lt;MaintenanceModeSetter&gt; mmSetter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">array</span>&lt;BSONElement, <span class="built_in">std</span>::tuple_size&lt;<span class="keyword">decltype</span>(neededFieldNames)&gt;::value&gt;</span><br><span class="line">            extractedFields&#123;&#125;;</span><br><span class="line">        request.getCommandArgs().getFields(neededFieldNames, &amp;extractedFields);</span><br><span class="line"></span><br><span class="line">        <span class="function">ImpersonationSessionGuard <span class="title">guard</span><span class="params">(txn)</span></span>;</span><br><span class="line"></span><br><span class="line">        repl::ReplicationCoordinator* replCoord =</span><br><span class="line">            repl::ReplicationCoordinator::get(txn-&gt;getClient()-&gt;getServiceContext());</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> iAmPrimary = replCoord-&gt;canAcceptWritesForDatabase(dbname);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> commandCanRunOnSecondary = command-&gt;slaveOk();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> commandIsOverriddenToRunOnSecondary = command-&gt;slaveOverrideOk() &amp;&amp;</span><br><span class="line">                rpc::ServerSelectionMetadata::get(txn).canRunOnSecondary();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> iAmStandalone = !txn-&gt;writesAreReplicated();</span><br><span class="line">            <span class="keyword">bool</span> canRunHere = iAmPrimary || commandCanRunOnSecondary ||</span><br><span class="line">                commandIsOverriddenToRunOnSecondary || iAmStandalone;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This logic is clearer if we don't have to invert it.</span></span><br><span class="line">            <span class="keyword">if</span> (!canRunHere &amp;&amp; command-&gt;slaveOverrideOk()) &#123;</span><br><span class="line">                uasserted(ErrorCodes::NotMasterNoSlaveOk, <span class="string">"not master and slaveOk=false"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (command-&gt;maintenanceMode()) &#123;</span><br><span class="line">            mmSetter.reset(<span class="keyword">new</span> MaintenanceModeSetter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (command-&gt;shouldAffectCommandCounter()) &#123;</span><br><span class="line">            OpCounters* opCounters = &amp;globalOpCounters;</span><br><span class="line">            opCounters-&gt;gotCommand();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle command option maxTimeMS.</span></span><br><span class="line">        <span class="keyword">int</span> maxTimeMS = uassertStatusOK(</span><br><span class="line">            LiteParsedQuery::parseMaxTimeMS(extractedFields[kCmdOptionMaxTimeMSField]));</span><br><span class="line"></span><br><span class="line">        CurOp::get(txn)-&gt;setMaxTimeMicros(<span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>&gt;(maxTimeMS) * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Operations are only versioned against the primary. We also make sure not to redo shard</span></span><br><span class="line">        <span class="comment">// version handling if this command was issued via the direct client.</span></span><br><span class="line">        <span class="keyword">if</span> (iAmPrimary &amp;&amp; !txn-&gt;getClient()-&gt;isInDirectClient()) &#123;</span><br><span class="line">            <span class="comment">// Handle shard version and config optime information that may have been sent along with</span></span><br><span class="line">            <span class="comment">// the command.</span></span><br><span class="line">            <span class="keyword">auto</span>&amp; operationShardVersion = OperationShardVersion::get(txn);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> commandNS = NamespaceString(command-&gt;parseNs(dbname, request.getCommandArgs()));</span><br><span class="line">            operationShardVersion.initializeFromCommand(commandNS,</span><br><span class="line">                                                        extractedFields[kShardVersionField]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can throw</span></span><br><span class="line">        txn-&gt;checkForInterrupt();  <span class="comment">// May trigger maxTimeAlwaysTimeOut fail point.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> retval = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        CurOp::get(txn)-&gt;ensureStarted();</span><br><span class="line"></span><br><span class="line">        command-&gt;_commandsExecuted.increment();</span><br><span class="line"></span><br><span class="line">        retval = command-&gt;run(txn, request, replyBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!retval) &#123;</span><br><span class="line">            command-&gt;_commandsFailed.increment();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Command 是整个mongodb 命令的基类, 他定义了所有mongodb command的基本属性,</p>
<p>这个类太重要了,以致于它的代码.我一行不删的贴出来. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** mongodb "commands" (sent via db.$cmd.findOne(...))</span></span><br><span class="line"><span class="comment">    subclass to make a command.  define a singleton object for it.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span> &#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// The type of the first field in 'cmdObj' must be mongo::String. The first field is</span></span><br><span class="line">    <span class="comment">// interpreted as a collection name.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">parseNsFullyQualified</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname, <span class="keyword">const</span> BSONObj&amp; cmdObj)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The type of the first field in 'cmdObj' must be mongo::String or Symbol.</span></span><br><span class="line">    <span class="comment">// The first field is interpreted as a collection name.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">parseNsCollectionRequired</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname, <span class="keyword">const</span> BSONObj&amp; cmdObj)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> StringMap&lt;Command*&gt; CommandMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> Do not remove this declaration, or relocate it in this class. We</span></span><br><span class="line">    <span class="comment">// are using this method to control where the vtable is emitted.</span></span><br><span class="line">    <span class="keyword">virtual</span> ~Command();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the namespace for the command. If the first field in 'cmdObj' is of type</span></span><br><span class="line">    <span class="comment">// mongo::String, then that field is interpreted as the collection name, and is</span></span><br><span class="line">    <span class="comment">// appended to 'dbname' after a '.' character. If the first field is not of type</span></span><br><span class="line">    <span class="comment">// mongo::String, then 'dbname' is returned unmodified.</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">parseNs</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname, <span class="keyword">const</span> BSONObj&amp; cmdObj)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Utility that returns a ResourcePattern for the namespace returned from</span></span><br><span class="line">    <span class="comment">// parseNs(dbname, cmdObj).  This will be either an exact namespace resource pattern</span></span><br><span class="line">    <span class="comment">// or a database resource pattern, depending on whether parseNs returns a fully qualifed</span></span><br><span class="line">    <span class="comment">// collection name or just a database name.</span></span><br><span class="line">    <span class="function">ResourcePattern <span class="title">parseResourcePattern</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname, <span class="keyword">const</span> BSONObj&amp; cmdObj)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> reserveBytesForReply() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0u</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* run the given command</span></span><br><span class="line"><span class="comment">       implement this...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       return value is true if succeeded.  if false, set errmsg text.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">run</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; db,</span></span></span><br><span class="line"><span class="function"><span class="params">                     BSONObj&amp; cmdObj,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> options,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="built_in">std</span>::<span class="built_in">string</span>&amp; errmsg,</span></span></span><br><span class="line"><span class="function"><span class="params">                     BSONObjBuilder&amp; result)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Translation point between the new request/response types and the legacy types.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Then we won't need to mutate the command object. At that point we can also make</span></span><br><span class="line"><span class="comment">     * this method virtual so commands can override it directly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*virtual*/</span> <span class="function"><span class="keyword">bool</span> <span class="title">run</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span></span></span><br><span class="line"><span class="function"><span class="params">                         rpc::ReplyBuilderInterface* replyBuilder)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This designation for the command is only used by the 'help' call and has nothing to do</span></span><br><span class="line"><span class="comment">     * with lock acquisition. The reason we need to have it there is because</span></span><br><span class="line"><span class="comment">     * SyncClusterConnection uses this to determine whether the command is update and needs to</span></span><br><span class="line"><span class="comment">     * be sent to all three servers or just one.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Eventually when SyncClusterConnection is refactored out, we can get rid of it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">isWriteCommandForConfigServer</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return true if only the admin ns has privileges to run this command. */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">adminOnly</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">htmlHelp</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">stringstream</span>&amp;)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Like adminOnly, but even stricter: we must either be authenticated for admin db,</span></span><br><span class="line"><span class="comment">       or, if running without auth, on the local interface.  Used for things which</span></span><br><span class="line"><span class="comment">       are so major that remote invocation may not make sense (e.g., shutdownServer).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       When localHostOnlyIfNoAuth() is true, adminOnly() must also be true.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">localHostOnlyIfNoAuth</span><span class="params">(<span class="keyword">const</span> BSONObj&amp; cmdObj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return true if slaves are allowed to execute the command</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">slaveOk</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return true if the client force a command to be run on a slave by</span></span><br><span class="line"><span class="comment">       turning on the 'slaveOk' option in the command query.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">slaveOverrideOk</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Override and return fales if the command opcounters should not be incremented on</span></span><br><span class="line"><span class="comment">     * behalf of this command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">shouldAffectCommandCounter</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">help</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">stringstream</span>&amp; help)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Commands which can be explained override this method. Any operation which has a query</span></span><br><span class="line"><span class="comment">     * part and executes as a tree of execution stages can be explained. A command should</span></span><br><span class="line"><span class="comment">     * implement explain by:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   1) Calling its custom parse function in order to parse the command. The output of</span></span><br><span class="line"><span class="comment">     *   this function should be a CanonicalQuery (representing the query part of the</span></span><br><span class="line"><span class="comment">     *   operation), and a PlanExecutor which wraps the tree of execution stages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   2) Calling Explain::explainStages(...) on the PlanExecutor. This is the function</span></span><br><span class="line"><span class="comment">     *   which knows how to convert an execution stage tree into explain output.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">TODO:</span> Remove the 'serverSelectionMetadata' parameter in favor of reading the</span></span><br><span class="line"><span class="comment">     * ServerSelectionMetadata off 'txn'. Once OP_COMMAND is implemented in mongos, this metadata</span></span><br><span class="line"><span class="comment">     * will be parsed and attached as a decoration on the OperationContext, as is already done on</span></span><br><span class="line"><span class="comment">     * the mongod side.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Status <span class="title">explain</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> BSONObj&amp; cmdObj,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ExplainCommon::Verbosity verbosity,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> rpc::ServerSelectionMetadata&amp; serverSelectionMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">                           BSONObjBuilder* out)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Status(ErrorCodes::IllegalOperation, <span class="string">"Cannot explain cmd: "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if the client associated with the given OperationContext, "txn", is authorized to run</span></span><br><span class="line"><span class="comment">     * this command on database "dbname" with the invocation described by "cmdObj".</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Status <span class="title">checkAuthForOperation</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         <span class="keyword">const</span> BSONObj&amp; cmdObj)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redacts "cmdObj" in-place to a form suitable for writing to logs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The default implementation does nothing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">redactForLogging</span><span class="params">(mutablebson::Document* cmdObj)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a copy of "cmdObj" in a form suitable for writing to logs.</span></span><br><span class="line"><span class="comment">     * Uses redactForLogging() to transform "cmdObj".</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">BSONObj <span class="title">getRedactedCopyForLogging</span><span class="params">(<span class="keyword">const</span> BSONObj&amp; cmdObj)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return true if a replica set secondary should go into "recovering"</span></span><br><span class="line"><span class="comment">       (unreadable) state while running this command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">maintenanceMode</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return true if command should be permitted when a replica set secondary is in "recovering"</span></span><br><span class="line"><span class="comment">       (unreadable) state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">maintenanceOk</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">/* assumed true prior to commit */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if this Command supports the readConcern argument.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the readConcern argument is sent to a command that returns false the command processor</span></span><br><span class="line"><span class="comment">     * will reject the command, returning an appropriate error message. For commands that support</span></span><br><span class="line"><span class="comment">     * the argument, the command processor will instruct the RecoveryUnit to only return</span></span><br><span class="line"><span class="comment">     * "committed" data, failing if this isn't supported by the storage engine.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Note that this is never called on mongos. Sharded commands are responsible for forwarding</span></span><br><span class="line"><span class="comment">     * the option to the shards as needed. We rely on the shards to fail the commands in the</span></span><br><span class="line"><span class="comment">     * cases where it isn't supported.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">supportsReadConcern</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> LogicalOp <span class="title">getLogicalOp</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LogicalOp::opCommand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @param webUI expose the command in the web ui as localhost:28017/&lt;name&gt;</span></span><br><span class="line"><span class="comment">        @param oldName an optional old, deprecated name for the command</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Command(StringData _name, <span class="keyword">bool</span> webUI = <span class="literal">false</span>, StringData oldName = StringData());</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function">BSONObj <span class="title">getQuery</span><span class="params">(<span class="keyword">const</span> BSONObj&amp; cmdObj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cmdObj[<span class="string">"query"</span>].type() == Object)</span><br><span class="line">            <span class="keyword">return</span> cmdObj[<span class="string">"query"</span>].embeddedObject();</span><br><span class="line">        <span class="keyword">if</span> (cmdObj[<span class="string">"q"</span>].type() == Object)</span><br><span class="line">            <span class="keyword">return</span> cmdObj[<span class="string">"q"</span>].embeddedObject();</span><br><span class="line">        <span class="keyword">return</span> BSONObj();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">logIfSlow</span><span class="params">(<span class="keyword">const</span> Timer&amp; cmdTimer, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; msg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> CommandMap* _commands;</span><br><span class="line">    <span class="keyword">static</span> CommandMap* _commandsByBestName;</span><br><span class="line">    <span class="keyword">static</span> CommandMap* _webCommands;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Counters for how many times this command has been executed and failed</span></span><br><span class="line">    Counter64 _commandsExecuted;</span><br><span class="line">    Counter64 _commandsFailed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pointers to hold the metrics tree references</span></span><br><span class="line">    ServerStatusMetricField&lt;Counter64&gt; _commandsExecutedMetric;</span><br><span class="line">    ServerStatusMetricField&lt;Counter64&gt; _commandsFailedMetric;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> CommandMap* <span class="title">commandsByBestName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _commandsByBestName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> CommandMap* <span class="title">webCommands</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _webCommands;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Counter for unknown commands</span></span><br><span class="line">    <span class="keyword">static</span> Counter64 unknownCommands;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAgainstRegistered</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> <span class="keyword">char</span>* ns,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     BSONObj&amp; jsobj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     BSONObjBuilder&amp; anObjBuilder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">int</span> queryOptions = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Command* <span class="title">findCommand</span><span class="params">(StringData name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Executes a command after stripping metadata, performing authorization checks,</span></span><br><span class="line"><span class="comment">     * handling audit impersonation, and (potentially) setting maintenance mode. This method</span></span><br><span class="line"><span class="comment">     * also checks that the command is permissible to run on the node given its current</span></span><br><span class="line"><span class="comment">     * replication state. All the logic here is independent of any particular command; any</span></span><br><span class="line"><span class="comment">     * functionality relevant to a specific command should be confined to its run() method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This is currently used by mongod and dbwebserver.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execCommand</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Command* command,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span></span></span><br><span class="line"><span class="function"><span class="params">                            rpc::ReplyBuilderInterface* replyBuilder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For mongos</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> remove this entirely now that all instances of ClientBasic are instances</span></span><br><span class="line">    <span class="comment">// of Client. This will happen as part of SERVER-18292</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">execCommandClientBasic</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Command* c,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       ClientBasic&amp; client,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> queryOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> <span class="keyword">char</span>* ns,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       BSONObj&amp; cmdObj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       BSONObjBuilder&amp; result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Helper for setting errmsg and ok field in command result object.</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendCommandStatus</span><span class="params">(BSONObjBuilder&amp; result, <span class="keyword">bool</span> ok, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; errmsg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @return s.isOK()</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">appendCommandStatus</span><span class="params">(BSONObjBuilder&amp; result, <span class="keyword">const</span> Status&amp; status)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Converts "result" into a Status object.  The input is expected to be the object returned</span></span><br><span class="line">    <span class="comment">// by running a command.  Returns ErrorCodes::CommandResultSchemaViolation if "result" does</span></span><br><span class="line">    <span class="comment">// not look like the result of a command.</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Status <span class="title">getStatusFromCommandResult</span><span class="params">(<span class="keyword">const</span> BSONObj&amp; result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parses cursor options from the command request object "cmdObj".  Used by commands that</span></span><br><span class="line"><span class="comment">     * take cursor options.  The only cursor option currently supported is "cursor.batchSize".</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If a valid batch size was specified, returns Status::OK() and fills in "batchSize" with</span></span><br><span class="line"><span class="comment">     * the specified value.  If no batch size was specified, returns Status::OK() and fills in</span></span><br><span class="line"><span class="comment">     * "batchSize" with the provided default value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If an error occurred while parsing, returns an error Status.  If this is the case, the</span></span><br><span class="line"><span class="comment">     * value pointed to by "batchSize" is unspecified.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Status <span class="title">parseCommandCursorOptions</span><span class="params">(<span class="keyword">const</span> BSONObj&amp; cmdObj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">long</span> <span class="keyword">long</span> defaultBatchSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">long</span> <span class="keyword">long</span>* batchSize)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper for setting a writeConcernError field in the command result object if</span></span><br><span class="line"><span class="comment">     * a writeConcern error occurs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendCommandWCStatus</span><span class="params">(BSONObjBuilder&amp; result, <span class="keyword">const</span> Status&amp; status)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If true, then testing commands are available. Defaults to false.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Testing commands should conditionally register themselves by consulting this flag:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     MONGO_INITIALIZER(RegisterMyTestCommand)(InitializerContext* context) &#123;</span></span><br><span class="line"><span class="comment">     *         if (Command::testCommandsEnabled) &#123;</span></span><br><span class="line"><span class="comment">     *             // Leaked intentionally: a Command registers itself when constructed.</span></span><br><span class="line"><span class="comment">     *             new MyTestCommand();</span></span><br><span class="line"><span class="comment">     *         &#125;</span></span><br><span class="line"><span class="comment">     *         return Status::OK();</span></span><br><span class="line"><span class="comment">     *     &#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * To make testing commands available by default, change the value to true before running any</span></span><br><span class="line"><span class="comment">     * mongo initializers:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     int myMain(int argc, char** argv, char** envp) &#123;</span></span><br><span class="line"><span class="comment">     *         static StaticObserver StaticObserver;</span></span><br><span class="line"><span class="comment">     *         Command::testCommandsEnabled = true;</span></span><br><span class="line"><span class="comment">     *         ...</span></span><br><span class="line"><span class="comment">     *         runGlobalInitializersOrDie(argc, argv, envp);</span></span><br><span class="line"><span class="comment">     *         ...</span></span><br><span class="line"><span class="comment">     *     &#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> testCommandsEnabled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if this a request for the 'help' information associated with the command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">isHelpRequest</span><span class="params">(<span class="keyword">const</span> BSONElement&amp; helpElem)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kHelpFieldName[];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generates a reply from the 'help' information associated with a command. The state of</span></span><br><span class="line"><span class="comment">     * the passed ReplyBuilder will be in kOutputDocs after calling this method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generateHelpResponse</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     rpc::ReplyBuilderInterface* replyBuilder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> Command&amp; command)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When an assertion is hit during command execution, this method is used to fill the fields</span></span><br><span class="line"><span class="comment">     * of the command reply with the information from the error. In addition, information about</span></span><br><span class="line"><span class="comment">     * the command is logged. This function does not return anything, because there is typically</span></span><br><span class="line"><span class="comment">     * already an active exception when this function is called, so there</span></span><br><span class="line"><span class="comment">     * is little that can be done if it fails.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generateErrorResponse</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      rpc::ReplyBuilderInterface* replyBuilder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> DBException&amp; exception,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> rpc::RequestInterface&amp; request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      Command* command,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> BSONObj&amp; metadata)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generates a command error response. This overload of generateErrorResponse is intended</span></span><br><span class="line"><span class="comment">     * to be called if the command is successfully parsed, but there is an error before we have</span></span><br><span class="line"><span class="comment">     * a handle to the actual Command object. This can happen, for example, when the command</span></span><br><span class="line"><span class="comment">     * is not found.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generateErrorResponse</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      rpc::ReplyBuilderInterface* replyBuilder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> DBException&amp; exception,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> rpc::RequestInterface&amp; request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generates a command error response. Similar to other overloads of generateErrorResponse,</span></span><br><span class="line"><span class="comment">     * but doesn't print any information about the specific command being executed. This is</span></span><br><span class="line"><span class="comment">     * neccessary, for example, if there is</span></span><br><span class="line"><span class="comment">     * an assertion hit while parsing the command.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generateErrorResponse</span><span class="params">(OperationContext* txn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      rpc::ReplyBuilderInterface* replyBuilder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> DBException&amp; exception)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Records the error on to the OperationContext. This hook is needed because mongos</span></span><br><span class="line"><span class="comment">     * does not have CurOp linked in to it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerError</span><span class="params">(OperationContext* txn, <span class="keyword">const</span> DBException&amp; exception)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks to see if the client executing "txn" is authorized to run the given command with the</span></span><br><span class="line"><span class="comment">     * given parameters on the given named database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns Status::OK() if the command is authorized.  Most likely returns</span></span><br><span class="line"><span class="comment">     * ErrorCodes::Unauthorized otherwise, but any return other than Status::OK implies not</span></span><br><span class="line"><span class="comment">     * authorized.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Status <span class="title">checkAuthorization</span><span class="params">(Command* c,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     OperationContext* client,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> BSONObj&amp; cmdObj)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if the given client is authorized to run this command on database "dbname"</span></span><br><span class="line"><span class="comment">     * with the invocation described by "cmdObj".</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">NOTE:</span> Implement checkAuthForOperation that takes an OperationContext* instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Status <span class="title">checkAuthForCommand</span><span class="params">(ClientBasic* client,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> BSONObj&amp; cmdObj)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appends to "*out" the privileges required to run this command on database "dbname" with</span></span><br><span class="line"><span class="comment">     * the invocation described by "cmdObj".  New commands shouldn't implement this, they should</span></span><br><span class="line"><span class="comment">     * implement checkAuthForCommand instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">addRequiredPrivileges</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> BSONObj&amp; cmdObj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Privilege&gt;* out)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The default implementation of addRequiredPrivileges should never be hit.</span></span><br><span class="line">        fassertFailed(<span class="number">16940</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://eharry.github.io/2018/02/18/037-mongod简易流程/" data-id="cjj2qpnbm001lzxvr5rzrv191" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb,</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/15/038-mongodbutil类之Decorable/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2018/02/17/036-c-代码如何使用nm得到可以合适的断点函数/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">036-c++代码如何使用nm得到可以合适的断点函数</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/configuration/">configuration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/example/">example</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk/">jdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk9/">jdk9</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jshell/">jshell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macos/">macos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb,</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nm-gdb/">nm, gdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scons-verbose-option/">scons, verbose, option</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/快捷键/">快捷键</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/身体检查/">身体检查</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/雷蛇/">雷蛇</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/configuration/" style="font-size: 10px;">configuration</a> <a href="/tags/example/" style="font-size: 10px;">example</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/jdk9/" style="font-size: 10px;">jdk9</a> <a href="/tags/jshell/" style="font-size: 10px;">jshell</a> <a href="/tags/macos/" style="font-size: 15px;">macos</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb,</a> <a href="/tags/mysql/" style="font-size: 20px;">mysql</a> <a href="/tags/nm-gdb/" style="font-size: 10px;">nm, gdb</a> <a href="/tags/scons-verbose-option/" style="font-size: 10px;">scons, verbose, option</a> <a href="/tags/快捷键/" style="font-size: 10px;">快捷键</a> <a href="/tags/身体检查/" style="font-size: 10px;">身体检查</a> <a href="/tags/雷蛇/" style="font-size: 10px;">雷蛇</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/15/038-mongodbutil类之Decorable/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/02/18/037-mongod简易流程/">037-mongod简易流程</a>
          </li>
        
          <li>
            <a href="/2018/02/17/036-c-代码如何使用nm得到可以合适的断点函数/">036-c++代码如何使用nm得到可以合适的断点函数</a>
          </li>
        
          <li>
            <a href="/2018/02/16/004-hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2018/02/04/035-如何引用定义不同类型转换时-会发生什么/">035-如何引用定义不同类型转换时-会发生什么</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>